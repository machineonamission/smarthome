# set sink.echo_cancel and rnnoise_source as system defaults
context.modules = [
  {
    name = libpipewire-module-echo-cancel
    args = {
      monitor.mode = false
      library.name = aec/libspa-aec-webrtc
      aec.args = {
        webrtc.extended_filter = true
        webrtc.delay_agnostic = true
        webrtc.high_pass_filter = true
        webrtc.voice_detection = false
        webrtc.experimental_ns = false
        webrtc.gain_control = true
        webrtc.experimental_agc = true
        webrtc.noise_suppression = false
      }
      # raw mic input goes into here
      capture.props = {
        node.name = "capture.echo_cancel"
        target.object = "alsa_input.usb-046d_C270_HD_WEBCAM_BE4980A0-02.mono-fallback"
        audio.channels = 1
      }
      # is echo cancelled and exposed as source
      source.props = {
        node.name = "source.echo_cancel"
        node.description = "Echo Cancelled Mic"
        audio.channels = 1
        target.object = "capture.rnnoise_source"
      }

      # app tries to play through here, module gets speaker info to cancel
      sink.props = {
        node.name = "sink.echo_cancel"
        audio.position = [FL FR]
        audio.channels = 2
      }
      # repeat of sink
      playback.props = {
        node.name = "playback.echo_cancel"
        target.object = "alsa_output.pci-0000_00_1f.3-platform-skl_hda_dsp_generic.HiFi__Speaker__sink"
        audio.position = [FL FR]
        audio.channels = 2
      }
    }
  }
  {
    name = libpipewire-module-filter-chain
    args = {
      node.description = "Normalized Sink"
      media.name = "Normalized Sink"
      filter.graph = {
        nodes = [
          {
            type = ladspa
            name = compressor
            plugin = sc4_1882
            label = sc4
            control = {
              # Changed to 1 (RMS) for smoother response to voice
              "RMS/peak" = 1
              # Faster attack to catch sudden TTS wakeups
              "Attack time (ms)" = 20
              # Faster release so the volume doesn't "pump" weirdly
              "Release time (ms)" = 250
              # Catch audio a bit earlier
              "Threshold level (dB)" = -15
              # 4:1 is the golden standard ratio for clear voice
              "Ratio (1:n)" = 4
              "Knee radius (dB)" = 3
              # Gentle boost instead of a massive +12dB jump
              "Makeup gain (dB)" = 6
            }
          }
          {
            type = ladspa
            name = limiter
            plugin = fast_lookahead_limiter_1913
            label = fastLookaheadLimiter
            control = {
              # We don't need more gain here, the compressor did it
              "Input gain (dB)" = 0
              # Limit slightly below 0 to prevent hardware speaker cracking
              "Limit (dB)" = -1.5
              "Release time (s)" = 0.4
            }
          }
        ]
        links = [
          {
            output = "compressor:Left output"
            input = "limiter:Input 1"
          }
          {
            output = "compressor:Right output"
            input = "limiter:Input 2"
          }
        ]
        inputs = ["compressor:Left input"
          "compressor:Right input"]
        outputs = ["limiter:Output 1"
          "limiter:Output 2"]
      }
      capture.props = {
        node.name = "effect_input.normalized"
        media.class = Audio/Sink
        audio.channels = 2
        audio.position = [FL FR]
      }
      playback.props = {
        node.name = "effect_output.normalized"
        audio.channels = 2
        audio.position = [FL FR]
        target.object = "sink.echo_cancel"
      }
    }
  }
  {
    name = libpipewire-module-filter-chain
    args = {
      node.description = "Noise Canceling source"
      media.name = "Noise Canceling source"
      filter.graph = {
        nodes = [
          {
            type = ladspa
            name = rnnoise
            plugin = /usr/lib64/ladspa/librnnoise_ladspa.so
            label = noise_suppressor_mono
            control = {
              "VAD Threshold (%)" = 50.0
              "VAD Grace Period (ms)" = 200
              "Retroactive VAD Grace (ms)" = 0
            }
          }
        ]
      }
      capture.props = {
        node.name = "capture.rnnoise_source"
        node.passive = true
        media.class = Audio/Sink
        audio.rate = 48000
        audio.channels = 1
      }
      playback.props = {
        node.name = "rnnoise_source"
        media.class = Audio/Source
        audio.rate = 48000
        audio.channels = 1
      }
    }
  }
]
